<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dollar Empire Alpha 0.4</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root {
            --bg-color: #121212;
            --panel-color: #1e1e1e;
            --text-color: #e0e0e0;
            --money-color: #4caf50;
            --button-color: #333;
            --button-hover: #444;
            --tab-active: #2d2d2d;
            --boost-color: #ff9800;
            --manager-color: #2196f3;
            --achievement-color: #9c27b0;
            --car-color: #ff5722;
        }
        body {
            font-family: 'Roboto', Arial, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            padding: 10px;
            user-select: none;
            touch-action: manipulation;
        }
        #header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background-color: var(--panel-color);
            padding: 15px;
            border-radius: 12px;
            margin-bottom: 10px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
        }
        #balance {
            font-size: 1.5em;
            font-weight: bold;
            color: var(--money-color);
        }
        #income-per-sec {
            font-size: 0.8em;
            color: #888;
        }
        #collect-all {
            background: linear-gradient(45deg, #ff6b00, #ffa000);
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
        }
        #tabs {
            display: flex;
            background-color: var(--panel-color);
            border-radius: 12px;
            margin-bottom: 10px;
            overflow-x: auto;
            flex-wrap: nowrap;
        }
        .tab-button {
            padding: 12px 15px;
            background: none;
            border: none;
            color: var(--text-color);
            cursor: pointer;
            text-align: center;
            font-weight: 500;
            white-space: nowrap;
            flex-shrink: 0;
        }
        .tab-button.active {
            background-color: var(--tab-active);
            font-weight: bold;
        }
        .tab-content {
            display: none;
            background-color: var(--panel-color);
            padding: 15px;
            border-radius: 12px;
            min-height: 50vh;
            max-height: 60vh;
            overflow-y: auto;
        }
        .tab-content.active {
            display: block;
        }
        #coin-container {
            text-align: center;
            padding: 20px 0;
        }
        #coin {
            width: 140px;
            height: 140px;
            background: radial-gradient(circle at 30% 30%, #ffd700, #daa520);
            border-radius: 50%;
            margin: 0 auto;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.1em;
            font-weight: bold;
            box-shadow: 0 0 30px rgba(255, 215, 0, 0.6);
            transition: transform 0.1s;
            position: relative;
        }
        #coin:active {
            transform: scale(0.92);
        }
        .coin-particle {
            position: absolute;
            width: 20px;
            height: 20px;
            background: gold;
            border-radius: 50%;
            pointer-events: none;
            animation: floatUp 1s ease-out forwards;
        }
        @keyframes floatUp {
            0% { transform: translate(0, 0); opacity: 1; }
            100% { transform: translate(var(--tx), var(--ty)); opacity: 0; }
        }
        #version {
            text-align: center;
            color: rgba(255, 255, 255, 0.3);
            font-size: 0.8em;
            margin-top: 5px;
        }
        .business-item, .upgrade-item, .manager-item, .boost-item, .achievement-item, .car-item {
            background-color: var(--button-color);
            padding: 15px;
            margin: 8px 0;
            border-radius: 10px;
            cursor: pointer;
            border: none;
            color: var(--text-color);
            text-align: left;
            width: 100%;
            transition: transform 0.2s;
        }
        .business-item:hover, .upgrade-item:hover, .manager-item:hover, .boost-item:hover, .achievement-item:hover, .car-item:hover {
            transform: translateY(-2px);
        }
        .business-item:disabled, .upgrade-item:disabled, .manager-item:disabled, .boost-item:disabled, .car-item:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }
        .business-header, .upgrade-header, .manager-header, .boost-header, .achievement-header, .car-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 5px;
        }
        .business-name, .upgrade-name, .manager-name, .boost-name, .achievement-name, .car-name {
            font-weight: bold;
            font-size: 1.1em;
        }
        .business-income {
            color: #4caf50;
            font-weight: bold;
        }
        .business-cost, .upgrade-cost, .manager-cost, .boost-cost, .car-cost {
            color: #f44336;
            font-weight: bold;
        }
        .business-level, .upgrade-level, .car-speed {
            color: #bb86fc;
            font-size: 0.9em;
        }
        .business-accumulated {
            color: #ff9800;
            margin-top: 5px;
            font-size: 0.9em;
        }
        .manager-owned {
            color: var(--manager-color);
            font-weight: bold;
        }
        .boost-timer {
            color: var(--boost-color);
            font-weight: bold;
        }
        .achievement-description {
            color: #ccc;
            font-size: 0.9em;
        }
        .achievement-progress {
            background: #333;
            height: 8px;
            border-radius: 4px;
            margin-top: 5px;
            overflow: hidden;
        }
        .achievement-progress-bar {
            background: var(--achievement-color);
            height: 100%;
            transition: width 0.3s;
        }
        .car-owned {
            color: var(--car-color);
            font-weight: bold;
        }
        .car-stats {
            display: flex;
            justify-content: space-between;
            margin-top: 5px;
            font-size: 0.9em;
        }
        .car-stat {
            color: #bbb;
        }
        #garage-view {
            text-align: center;
            padding: 20px;
        }
        #current-car {
            font-size: 2em;
            margin: 20px 0;
        }
        #car-name {
            font-size: 1.5em;
            color: var(--car-color);
            margin: 10px 0;
        }
        #leaderboard-list, #cars-list {
            max-height: 50vh;
            overflow-y: auto;
        }
        .leaderboard-item {
            padding: 10px;
            margin: 5px 0;
            background: #2a2a2a;
            border-radius: 8px;
            display: flex;
            justify-content: space-between;
        }
        .leaderboard-rank {
            font-weight: bold;
            color: #ffd700;
            margin-right: 10px;
        }
        .leaderboard-name {
            flex-grow: 1;
        }
        .leaderboard-score {
            color: var(--money-color);
            font-weight: bold;
        }
        .stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }
        .stat-item {
            background: #2a2a2a;
            padding: 10px;
            border-radius: 8px;
            text-align: center;
        }
        .stat-value {
            font-size: 1.2em;
            font-weight: bold;
            color: var(--money-color);
        }
        .stat-label {
            font-size: 0.8em;
            color: #888;
        }
        .notification {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: #333;
            color: white;
            padding: 10px 20px;
            border-radius: 20px;
            z-index: 1000;
            animation: fadeInOut 2s ease-in-out;
        }
        @keyframes fadeInOut {
            0%, 100% { opacity: 0; transform: translate(-50%, -20px); }
            10%, 90% { opacity: 1; transform: translate(-50%, 0); }
        }
        #business-list, #upgrades-list, #managers-list, #boosts-list, #achievements-list {
            max-height: 55vh;
            overflow-y: auto;
        }
        .combo-meter {
            height: 5px;
            background: #333;
            border-radius: 3px;
            margin: 10px 0;
            overflow: hidden;
        }
        .combo-fill {
            height: 100%;
            background: linear-gradient(90deg, #ff0000, #ffff00, #00ff00);
            transition: width 0.3s;
        }
    </style>
</head>
<body>
    <div id="header">
        <div>
            <div id="balance">$0.00</div>
            <div id="income-per-sec">+$0.0/сек</div>
            <div id="combo-text" style="font-size:0.8em;color:#ff9800;"></div>
        </div>
        <button id="collect-all" onclick="collectAllIncome()">СОБРАТЬ ВСЁ</button>
    </div>

    <div class="combo-meter">
        <div id="combo-fill" class="combo-fill" style="width:0%"></div>
    </div>

    <div id="tabs">
        <button class="tab-button active" onclick="switchTab('main')">Главная</button>
        <button class="tab-button" onclick="switchTab('business')">Бизнес</button>
        <button class="tab-button" onclick="switchTab('upgrades')">Улучшения</button>
        <button class="tab-button" onclick="switchTab('managers')">Менеджеры</button>
        <button class="tab-button" onclick="switchTab('cars')">Гараж</button>
        <button class="tab-button" onclick="switchTab('boosts')">Бусты</button>
        <button class="tab-button" onclick="switchTab('achievements')">Достижения</button>
        <button class="tab-button" onclick="switchTab('leaderboard')">Топ</button>
        <button class="tab-button" onclick="switchTab('stats')">Статистика</button>
    </div>

    <div id="main-tab" class="tab-content active">
        <div id="coin-container">
            <div id="coin" onclick="clickCoin()">КЛИКАЙ!</div>
            <p>За клик: <span id="coins-per-click">1</span>$</p>
            <div id="version">Alpha 0.4</div>
        </div>
        <button onclick="claimChannelBonus()" style="margin-top:20px;width:100%;">
            🎁 Получить +100$ за подписку на канал
        </button>
    </div>

    <div id="business-tab" class="tab-content">
        <div id="business-list"></div>
    </div>

    <div id="upgrades-tab" class="tab-content">
        <div id="upgrades-list"></div>
    </div>

    <div id="managers-tab" class="tab-content">
        <div id="managers-list"></div>
    </div>

    <div id="cars-tab" class="tab-content">
        <div id="garage-view">
            <div>Текущая машина:</div>
            <div id="current-car">🚶 Пешком</div>
            <div id="car-name">Без транспорта</div>
            <div id="car-speed">Скорость: 0 км/ч</div>
        </div>
        <div id="cars-list"></div>
    </div>

    <div id="boosts-tab" class="tab-content">
        <div id="boosts-list"></div>
    </div>

    <div id="achievements-tab" class="tab-content">
        <div id="achievements-list"></div>
    </div>

    <div id="leaderboard-tab" class="tab-content">
        <div id="leaderboard-list"></div>
        <button onclick="updateGlobalLeaderboard()" style="margin-top:10px;width:100%;">
            🔄 Обновить таблицу лидеров
        </button>
    </div>

    <div id="stats-tab" class="tab-content">
        <div class="stats-grid">
            <div class="stat-item">
                <div class="stat-value" id="stat-total-earned">0</div>
                <div class="stat-label">Всего заработано</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="stat-total-clicks">0</div>
                <div class="stat-label">Всего кликов</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="stat-total-businesses">0</div>
                <div class="stat-label">Куплено бизнесов</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="stat-total-cars">0</div>
                <div class="stat-label">Куплено машин</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="stat-play-time">0</div>
                <div class="stat-label">Время игры (час)</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="stat-achievements">0/0</div>
                <div class="stat-label">Достижения</div>
            </div>
        </div>
    </div>

    <script>
        // КОНФИГУРАЦИЯ ИГРЫ - Alpha 0.4
        const businessesConfig = [
            { name: "Лимонный киоск", baseCost: 15, baseIncome: 0.1, icon: "🍋" },
            { name: "Гаражный стартап", baseCost: 100, baseIncome: 1, icon: "💻" },
            { name: "Небольшой банк", baseCost: 500, baseIncome: 5, icon: "🏦" },
            { name: "Нефтяная вышка", baseCost: 1200, baseIncome: 15, icon: "🛢️" },
            { name: "Tech Giant", baseCost: 5000, baseIncome: 50, icon: "📱" },
        ];

        const managersConfig = [
            { name: "Студент-стажер", businessIndex: 0, cost: 1000, description: "Автосбор для Лимонного киоска" },
            { name: "Junior разработчик", businessIndex: 1, cost: 5000, description: "Автосбор для Гаража" },
            { name: "Банкир", businessIndex: 2, cost: 15000, description: "Автосбор для Банка" },
            { name: "Нефтяной магнат", businessIndex: 3, cost: 50000, description: "Автосбор для Вышки" },
            { name: "CEO", businessIndex: 4, cost: 200000, description: "Автосбор для Tech Giant" },
        ];

        // НОВОЕ В 0.4: КРУТЫЕ ТАЧКИ ДЛЯ ПОНТОВ! 🚗
        const carsConfig = [
            { name: "Велосипед", emoji: "🚲", cost: 5000, speed: 20, boost: 1.0, description: "Начни с малого" },
            { name: "Мотоцикл", emoji: "🏍️", cost: 25000, speed: 120, boost: 1.1, description: "Уже стильно" },
            { name: "Седан", emoji: "🚗", cost: 100000, speed: 180, boost: 1.2, description: "Для бизнеса" },
            { name: "Спорткар", emoji: "🏎️", cost: 500000, speed: 320, boost: 1.5, description: "Скорость!" },
            { name: "Ламборджини", emoji: "💎", cost: 2000000, speed: 350, boost: 2.0, description: "Роскошь" },
            { name: "Хеликоптер", emoji: "🚁", cost: 5000000, speed: 280, boost: 2.5, description: "Над пробками" },
            { name: "Частный самолет", emoji: "✈️", cost: 20000000, speed: 900, boost: 3.0, description: "Между континентами" },
            { name: "Ракета", emoji: "🚀", cost: 100000000, speed: 28000, boost: 5.0, description: "Космический уровень" }
        ];

        const boostsConfig = [
            { name: "Золотая лихорадка", cost: 500, duration: 30, description: "2x доход от бизнеса", effect: (game) => { game.boostMultiplier = 2; } },
            { name: "Суперклик", cost: 300, duration: 15, description: "10x доход за клик", effect: (game) => { game.clickBoostMultiplier = 10; } },
            { name: "Экономический рост", cost: 1000, duration: 20, description: "+5% дохода каждую секунду", effect: (game) => { game.growthBoost = true; } }
        ];

        const achievementsConfig = [
            { id: "first_million", name: "Первый миллион", description: "Заработать 1,000,000$", goal: 1000000, reward: 50000 },
            { id: "click_master", name: "Мастер клика", description: "Сделать 1000 кликов", goal: 1000, reward: 1000 },
            { id: "business_tycoon", name: "Бизнес-магнат", description: "Купить 50 бизнесов", goal: 50, reward: 5000 },
            { id: "manager_pro", name: "Профи менеджмента", description: "Нанять всех менеджеров", goal: managersConfig.length, reward: 25000 },
            { id: "car_collector", name: "Коллекционер", description: "Купить 3 машины", goal: 3, reward: 10000 },
            { id: "speed_demon", name: "Гонщик", description: "Разогнаться до 300+ км/ч", goal: 300, reward: 15000 }
        ];

        // СОСТОЯНИЕ ИГРЫ - Alpha 0.4
        let gameState = {
            money: 100,
            coinsPerClick: 1,
            totalEarned: 0,
            totalClicks: 0,
            totalBusinesses: 0,
            totalCars: 0,
            playTime: 0,
            lastSaveTime: Date.now(),
            lastUpdateTime: Date.now(),
            lastClickTime: 0,
            combo: 0,
            comboMultiplier: 1,
            comboTimeout: null,
            
            businesses: businessesConfig.map(biz => ({
                ...biz,
                level: 0,
                income: 0,
                cost: biz.baseCost,
                accumulatedIncome: 0
            })),
            
            managers: managersConfig.map(manager => ({
                ...manager,
                owned: false
            })),
            
            // НОВОЕ: СИСТЕМА МАШИН
            cars: carsConfig.map(car => ({
                ...car,
                owned: false
            })),
            currentCar: null,
            
            boosts: boostsConfig.map(boost => ({
                ...boost,
                active: false,
                timeLeft: 0
            })),
            
            achievements: achievementsConfig.map(ach => ({
                ...ach,
                progress: 0,
                completed: false,
                claimed: false
            })),
            
            boostMultiplier: 1,
            clickBoostMultiplier: 1,
            growthBoost: false,
            growthBoostProgress: 0,
            channelBonusClaimed: false
        };

        // ТЕЛЕГРАМ
        const tg = window.Telegram.WebApp;
        tg.expand();
        tg.BackButton.hide();
        tg.ready();

        // ИНИЦИАЛИЗАЦИЯ
        function initGame() {
            loadGame();
            renderAllSections();
            updateUI();
            startGameLoop();
            calculateOfflineEarnings();
            loadGlobalLeaderboard();
        }

        // НОВОЕ В 0.4: СИСТЕМА КОМБО
        function updateCombo() {
            const now = Date.now();
            const timeDiff = now - gameState.lastClickTime;
            
            if (timeDiff < 300) { // Клики быстрее 300ms = комбо
                gameState.combo++;
                gameState.comboMultiplier = 1 + (gameState.combo * 0.1);
                
                // Ограничиваем комбо множитель до 5x
                if (gameState.comboMultiplier > 5) {
                    gameState.comboMultiplier = 5;
                }
            } else {
                gameState.combo = 1;
                gameState.comboMultiplier = 1;
            }
            
            gameState.lastClickTime = now;
            
            // Сбрасываем комбо через 1 секунду бездействия
            clearTimeout(gameState.comboTimeout);
            gameState.comboTimeout = setTimeout(() => {
                gameState.combo = 0;
                gameState.comboMultiplier = 1;
                updateUI();
            }, 1000);
        }

        // НОВОЕ В 0.4: АНИМАЦИИ ЧАСТИЦ
        function createCoinParticles(x, y) {
            for (let i = 0; i < 5; i++) {
                const particle = document.createElement('div');
                particle.className = 'coin-particle';
                particle.style.setProperty('--tx', `${(Math.random() - 0.5) * 100}px`);
                particle.style.setProperty('--ty', `${-Math.random() * 100 - 50}px`);
                particle.style.left = `${x}px`;
                particle.style.top = `${y}px`;
                document.getElementById('coin-container').appendChild(particle);
                
                setTimeout(() => particle.remove(), 1000);
            }
        }

        // ИГРОВОЙ ЦИКЛ
        function startGameLoop() {
            setInterval(() => {
                updateBusinessIncome();
                updateBoosts();
                updateAchievements();
                updateStats();
                gameState.playTime += 1/3600;
                updateUI();
            }, 1000);

            setInterval(saveGame, 30000);
        }

        function updateBusinessIncome() {
            const now = Date.now();
            const deltaTime = (now - gameState.lastUpdateTime) / 1000;
            gameState.lastUpdateTime = now;

            gameState.businesses.forEach(business => {
                if (business.level > 0) {
                    let income = business.income * gameState.boostMultiplier;
                    
                    // НОВОЕ: БОНУС ОТ ТЕКУЩЕЙ МАШИНЫ
                    if (gameState.currentCar) {
                        income *= gameState.currentCar.boost;
                    }
                    
                    if (gameState.growthBoost) {
                        income *= (1 + gameState.growthBoostProgress * 0.05);
                    }

                    const incomeThisFrame = income * deltaTime;
                    business.accumulatedIncome += incomeThisFrame;
                }
            });

            if (gameState.growthBoost) {
                gameState.growthBoostProgress += deltaTime;
            }
        }

        function updateBoosts() {
            gameState.boosts.forEach(boost => {
                if (boost.active) {
                    boost.timeLeft -= 1;
                    if (boost.timeLeft <= 0) {
                        boost.active = false;
                        if (boost.name === "Золотая лихорадка") gameState.boostMultiplier = 1;
                        if (boost.name === "Суперклик") gameState.clickBoostMultiplier = 1;
                        if (boost.name === "Экономический рост") {
                            gameState.growthBoost = false;
                            gameState.growthBoostProgress = 0;
                        }
                    }
                }
            });
        }

        function updateAchievements() {
            gameState.achievements.forEach((achievement, index) => {
                if (!achievement.completed) {
                    let progress = 0;
                    switch(achievement.id) {
                        case "first_million":
                            progress = gameState.totalEarned;
                            break;
                        case "click_master":
                            progress = gameState.totalClicks;
                            break;
                        case "business_tycoon":
                            progress = gameState.totalBusinesses;
                            break;
                        case "manager_pro":
                            progress = gameState.managers.filter(m => m.owned).length;
                            break;
                        case "car_collector":
                            progress = gameState.cars.filter(c => c.owned).length;
                            break;
                        case "speed_demon":
                            progress = gameState.currentCar ? gameState.currentCar.speed : 0;
                            break;
                    }
                    
                    achievement.progress = Math.min(progress, achievement.goal);
                    if (achievement.progress >= achievement.goal) {
                        achievement.completed = true;
                        showNotification(`Достижение: ${achievement.name}!`);
                    }
                }
            });
        }

        function updateStats() {
            document.getElementById('stat-total-earned').textContent = Math.floor(gameState.totalEarned).toLocaleString();
            document.getElementById('stat-total-clicks').textContent = gameState.totalClicks.toLocaleString();
            document.getElementById('stat-total-businesses').textContent = gameState.totalBusinesses;
            document.getElementById('stat-total-cars').textContent = gameState.cars.filter(c => c.owned).length;
            document.getElementById('stat-play-time').textContent = gameState.playTime.toFixed(1);
            document.getElementById('stat-achievements').textContent = 
                `${gameState.achievements.filter(a => a.completed).length}/${gameState.achievements.length}`;
        }

        // ОСНОВНЫЕ ДЕЙСТВИЯ
        function clickCoin(event) {
            // НОВОЕ: АНИМАЦИИ И КОМБО
            if (event) {
                const rect = document.getElementById('coin').getBoundingClientRect();
                const x = event.clientX - rect.left;
                const y = event.clientY - rect.top;
                createCoinParticles(x, y);
            }
            
            updateCombo();
            
            const clickValue = gameState.coinsPerClick * gameState.clickBoostMultiplier * gameState.comboMultiplier;
            gameState.money += clickValue;
            gameState.totalEarned += clickValue;
            gameState.totalClicks++;
            updateUI();
        }

        function collectAllIncome() {
            let totalCollected = 0;
            gameState.businesses.forEach(business => {
                if (business.accumulatedIncome > 0) {
                    totalCollected += business.accumulatedIncome;
                    business.accumulatedIncome = 0;
                }
            });
            
            if (totalCollected > 0) {
                gameState.money += totalCollected;
                gameState.totalEarned += totalCollected;
                showNotification(`+$${totalCollected.toFixed(2)}`);
                updateUI();
            }
        }

        function buyBusiness(index) {
            const business = gameState.businesses[index];
            if (gameState.money >= business.cost) {
                gameState.money -= business.cost;
                business.level += 1;
                business.income = business.baseIncome * business.level;
                business.cost = Math.ceil(business.baseCost * Math.pow(1.5, business.level));
                
                gameState.totalBusinesses++;
                updateUI();
                renderBusiness(index);
            }
        }

        function buyUpgrade() {
            const nextCost = Math.floor(10 * Math.pow(gameState.coinsPerClick, 1.5));
            if (gameState.money >= nextCost) {
                gameState.money -= nextCost;
                gameState.coinsPerClick += 1;
                updateUI();
                renderUpgrades();
            }
        }

        function hireManager(index) {
            const manager = gameState.managers[index];
            if (!manager.owned && gameState.money >= manager.cost) {
                gameState.money -= manager.cost;
                manager.owned = true;
                
                // Автоматический сбор для этого бизнеса
                const business = gameState.businesses[manager.businessIndex];
                setInterval(() => {
                    if (business.accumulatedIncome > 0) {
                        gameState.money += business.accumulatedIncome;
                        gameState.totalEarned += business.accumulatedIncome;
                        business.accumulatedIncome = 0;
                        updateUI();
                    }
                }, 1000);
                
                updateUI();
                renderManager(index);
            }
        }

        // НОВОЕ В 0.4: ПОКУПКА МАШИН
        function buyCar(index) {
            const car = gameState.cars[index];
            if (!car.owned && gameState.money >= car.cost) {
                gameState.money -= car.cost;
                car.owned = true;
                gameState.currentCar = car;
                gameState.totalCars++;
                
                showNotification(`🎉 Куплена ${car.emoji} ${car.name}!`);
                updateUI();
                renderCars();
                updateGarageView();
            }
        }

        function selectCar(index) {
            const car = gameState.cars[index];
            if (car.owned) {
                gameState.currentCar = car;
                showNotification(`Выбрана ${car.emoji} ${car.name}`);
                updateGarageView();
            }
        }

        function updateGarageView() {
            if (gameState.currentCar) {
                document.getElementById('current-car').textContent = gameState.currentCar.emoji;
                document.getElementById('car-name').textContent = gameState.currentCar.name;
                document.getElementById('car-speed').textContent = `Скорость: ${gameState.currentCar.speed} км/ч`;
            } else {
                document.getElementById('current-car').textContent = "🚶";
                document.getElementById('car-name').textContent = "Пешком";
                document.getElementById('car-speed').textContent = "Скорость: 5 км/ч";
            }
        }

        function activateBoost(index) {
            const boost = gameState.boosts[index];
            if (!boost.active && gameState.money >= boost.cost) {
                gameState.money -= boost.cost;
                boost.active = true;
                boost.timeLeft = boost.duration;
                boost.effect(gameState);
                updateUI();
                renderBoost(index);
            }
        }

        function claimAchievement(index) {
            const achievement = gameState.achievements[index];
            if (achievement.completed && !achievement.claimed) {
                achievement.claimed = true;
                gameState.money += achievement.reward;
                showNotification(`Достижение: +$${achievement.reward}`);
                updateUI();
                renderAchievement(index);
            }
        }

        function claimChannelBonus() {
            if (!gameState.channelBonusClaimed) {
                tg.openTelegramLink('https://t.me/hammer_head_channel');
                gameState.money += 100;
                gameState.channelBonusClaimed = true;
                showNotification('+100$ за подписку!');
                updateUI();
            }
        }

        // ТАБЛИЦА ЛИДЕРОВ
        async function updateGlobalLeaderboard() {
            try {
                const leaderboardKey = 'dollar_empire_leaderboard';
                let leaderboard = JSON.parse(tg.CloudStorage.getItem(leaderboardKey) || '[]');
                
                const user = tg.initDataUnsafe.user;
                const userId = user?.id || 'anonymous';
                const username = user?.username || 'Player';
                
                const existingIndex = leaderboard.findIndex(entry => entry.userId === userId);
                
                if (existingIndex !== -1) {
                    if (gameState.totalEarned > leaderboard[existingIndex].score) {
                        leaderboard[existingIndex].score = gameState.totalEarned;
                    }
                } else {
                    leaderboard.push({
                        userId,
                        username,
                        score: gameState.totalEarned
                    });
                }
                
                leaderboard.sort((a, b) => b.score - a.score);
                leaderboard = leaderboard.slice(0, 100);
                
                tg.CloudStorage.setItem(leaderboardKey, JSON.stringify(leaderboard));
                loadGlobalLeaderboard();
                showNotification('Таблица лидеров обновлена!');
                
            } catch (error) {
                console.error('Ошибка обновления лидерборда:', error);
            }
        }

        function loadGlobalLeaderboard() {
            try {
                const leaderboardKey = 'dollar_empire_leaderboard';
                const leaderboard = JSON.parse(tg.CloudStorage.getItem(leaderboardKey) || '[]');
                const list = document.getElementById('leaderboard-list');
                
                list.innerHTML = '';
                leaderboard.slice(0, 10).forEach((entry, index) => {
                    const item = document.createElement('div');
                    item.className = 'leaderboard-item';
                    item.innerHTML = `
                        <span class="leaderboard-rank">#${index + 1}</span>
                        <span class="leaderboard-name">${entry.username}</span>
                        <span class="leaderboard-score">$${entry.score.toLocaleString()}</span>
                    `;
                    list.appendChild(item);
                });
            } catch (error) {
                console.error('Ошибка загрузки лидерборда:', error);
            }
        }

        // РЕНДЕР ИНТЕРФЕЙСА
        function switchTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));

            document.getElementById(`${tabName}-tab`).classList.add('active');
            document.querySelector(`button[onclick="switchTab('${tabName}')"]`).classList.add('active');
        }

        function renderAllSections() {
            renderBusinesses();
            renderUpgrades();
            renderManagers();
            renderCars();
            renderBoosts();
            renderAchievements();
        }

        function renderBusinesses() {
            const container = document.getElementById('business-list');
            container.innerHTML = '';
            
            gameState.businesses.forEach((business, index) => {
                const bizElement = document.createElement('button');
                bizElement.className = 'business-item';
                bizElement.onclick = () => buyBusiness(index);
                bizElement.innerHTML = `
                    <div class="business-header">
                        <span class="business-name">${business.icon} ${business.name}</span>
                        <span class="business-income">+$${business.income.toFixed(1)}/сек</span>
                    </div>
                    <div class="business-header">
                        <span class="business-level">Уровень: ${business.level}</span>
                        <span class="business-cost">$${business.cost}</span>
                    </div>
                    ${business.accumulatedIncome > 0 ? 
                        `<div class="business-accumulated">Накоплено: $${business.accumulatedIncome.toFixed(1)}</div>` : ''
                    }
                `;
                bizElement.disabled = gameState.money < business.cost;
                container.appendChild(bizElement);
            });
        }

        function renderBusiness(index) {
            const business = gameState.businesses[index];
            const buttons = document.querySelectorAll('.business-item');
            if (buttons[index]) {
                buttons[index].innerHTML = `
                    <div class="business-header">
                        <span class="business-name">${business.icon} ${business.name}</span>
                        <span class="business-income">+$${business.income.toFixed(1)}/сек</span>
                    </div>
                    <div class="business-header">
                        <span class="business-level">Уровень: ${business.level}</span>
                        <span class="business-cost">$${business.cost}</span>
                    </div>
                    ${business.accumulatedIncome > 0 ? 
                        `<div class="business-accumulated">Накоплено: $${business.accumulatedIncome.toFixed(1)}</div>` : ''
                    }
                `;
                buttons[index].disabled = gameState.money < business.cost;
            }
        }

        function renderUpgrades() {
            const container = document.getElementById('upgrades-list');
            const nextCost = Math.floor(10 * Math.pow(gameState.coinsPerClick, 1.5));
            
            container.innerHTML = `
                <button class="upgrade-item" onclick="buyUpgrade()">
                    <div class="upgrade-header">
                        <span class="upgrade-name">💎 Улучшение монеты</span>
                        <span class="upgrade-cost">$${nextCost}</span>
                    </div>
                    <div>+1$ за клик (Уровень ${gameState.coinsPerClick})</div>
                </button>
            `;
        }

        function renderManagers() {
            const container = document.getElementById('managers-list');
            container.innerHTML = '';
            
            gameState.managers.forEach((manager, index) => {
                const business = gameState.businesses[manager.businessIndex];
                const managerElement = document.createElement('button');
                managerElement.className = 'manager-item';
                managerElement.onclick = () => hireManager(index);
                managerElement.innerHTML = `
                    <div class="manager-header">
                        <span class="manager-name">👔 ${manager.name}</span>
                        <span class="manager-cost">$${manager.cost}</span>
                    </div>
                    <div>${manager.description}</div>
                    ${manager.owned ? '<div class="manager-owned">✔ Нанят</div>' : ''}
                `;
                managerElement.disabled = manager.owned || gameState.money < manager.cost;
                container.appendChild(managerElement);
            });
        }

        // НОВОЕ В 0.4: РЕНДЕР МАШИН
        function renderCars() {
            const container = document.getElementById('cars-list');
            container.innerHTML = '';
            
            gameState.cars.forEach((car, index) => {
                const carElement = document.createElement('button');
                carElement.className = 'car-item';
                
                if (car.owned) {
                    carElement.onclick = () => selectCar(index);
                    carElement.innerHTML = `
                        <div class="car-header">
                            <span class="car-name">${car.emoji} ${car.name}</span>
                            <span class="car-owned">✔ Куплена</span>
                        </div>
                        <div class="car-stats">
                            <span class="car-stat">Скорость: ${car.speed} км/ч</span>
                            <span class="car-stat">Бонус: ${car.boost}x</span>
                        </div>
                        <div>${car.description}</div>
                        ${gameState.currentCar === car ? '<div style="color:#4caf50;margin-top:5px;">▶ Выбрана</div>' : 
                          '<div style="color:#ff9800;margin-top:5px;">🎯 Выбрать</div>'}
                    `;
                } else {
                    carElement.onclick = () => buyCar(index);
                    carElement.innerHTML = `
                        <div class="car-header">
                            <span class="car-name">${car.emoji} ${car.name}</span>
                            <span class="car-cost">$${car.cost.toLocaleString()}</span>
                        </div>
                        <div class="car-stats">
                            <span class="car-stat">Скорость: ${car.speed} км/ч</span>
                            <span class="car-stat">Бонус: ${car.boost}x</span>
                        </div>
                        <div>${car.description}</div>
                    `;
                    carElement.disabled = gameState.money < car.cost;
                }
                
                container.appendChild(carElement);
            });
        }

        function renderManager(index) {
            const manager = gameState.managers[index];
            const buttons = document.querySelectorAll('.manager-item');
            if (buttons[index]) {
                buttons[index].innerHTML = `
                    <div class="manager-header">
                        <span class="manager-name">👔 ${manager.name}</span>
                        <span class="manager-cost">$${manager.cost}</span>
                    </div>
                    <div>${manager.description}</div>
                    ${manager.owned ? '<div class="manager-owned">✔ Нанят</div>' : ''}
                `;
                buttons[index].disabled = manager.owned || gameState.money < manager.cost;
            }
        }

        function renderBoosts() {
            const container = document.getElementById('boosts-list');
            container.innerHTML = '';
            
            gameState.boosts.forEach((boost, index) => {
                const boostElement = document.createElement('button');
                boostElement.className = 'boost-item';
                boostElement.onclick = () => activateBoost(index);
                boostElement.innerHTML = `
                    <div class="boost-header">
                        <span class="boost-name">⚡ ${boost.name}</span>
                        <span class="boost-cost">$${boost.cost}</span>
                    </div>
                    <div>${boost.description}</div>
                    ${boost.active ? `<div class="boost-timer">⏰ ${boost.timeLeft}сек</div>` : ''}
                `;
                boostElement.disabled = boost.active || gameState.money < boost.cost;
                container.appendChild(boostElement);
            });
        }

        function renderBoost(index) {
            const boost = gameState.boosts[index];
            const buttons = document.querySelectorAll('.boost-item');
            if (buttons[index]) {
                buttons[index].innerHTML = `
                    <div class="boost-header">
                        <span class="boost-name">⚡ ${boost.name}</span>
                        <span class="boost-cost">$${boost.cost}</span>
                    </div>
                    <div>${boost.description}</div>
                    ${boost.active ? `<div class="boost-timer">⏰ ${boost.timeLeft}сек</div>` : ''}
                `;
                buttons[index].disabled = boost.active || gameState.money < boost.cost;
            }
        }

        function renderAchievements() {
            const container = document.getElementById('achievements-list');
            container.innerHTML = '';
            
            gameState.achievements.forEach((achievement, index) => {
                const progressPercent = (achievement.progress / achievement.goal) * 100;
                const achievementElement = document.createElement('button');
                achievementElement.className = 'achievement-item';
                achievementElement.onclick = () => claimAchievement(index);
                achievementElement.innerHTML = `
                    <div class="achievement-header">
                        <span class="achievement-name">🏆 ${achievement.name}</span>
                        ${achievement.claimed ? '<span style="color:#4caf50">✔</span>' : 
                          achievement.completed ? '<span style="color:#ff9800">🎁</span>' : ''}
                    </div>
                    <div class="achievement-description">${achievement.description}</div>
                    <div class="achievement-progress">
                        <div class="achievement-progress-bar" style="width: ${progressPercent}%"></div>
                    </div>
                    <div>Прогресс: ${achievement.progress}/${achievement.goal}</div>
                    ${achievement.completed && !achievement.claimed ? 
                        '<div style="color: #ff9800; margin-top: 5px;">Награда: $' + achievement.reward + '</div>' : ''}
                    ${achievement.claimed ? '<div style="color: #4caf50; margin-top: 5px;">✔ Награда получена</div>' : ''}
                `;
                achievementElement.disabled = !achievement.completed || achievement.claimed;
                container.appendChild(achievementElement);
            });
        }

        function renderAchievement(index) {
            const achievement = gameState.achievements[index];
            const buttons = document.querySelectorAll('.achievement-item');
            if (buttons[index]) {
                const progressPercent = (achievement.progress / achievement.goal) * 100;
                buttons[index].innerHTML = `
                    <div class="achievement-header">
                        <span class="achievement-name">🏆 ${achievement.name}</span>
                        ${achievement.claimed ? '<span style="color:#4caf50">✔</span>' : 
                          achievement.completed ? '<span style="color:#ff9800">🎁</span>' : ''}
                    </div>
                    <div class="achievement-description">${achievement.description}</div>
                    <div class="achievement-progress">
                        <div class="achievement-progress-bar" style="width: ${progressPercent}%"></div>
                    </div>
                    <div>Прогресс: ${achievement.progress}/${achievement.goal}</div>
                    ${achievement.completed && !achievement.claimed ? 
                        '<div style="color: #ff9800; margin-top: 5px;">Награда: $' + achievement.reward + '</div>' : ''}
                    ${achievement.claimed ? '<div style="color: #4caf50; margin-top: 5px;">✔ Награда получена</div>' : ''}
                `;
                buttons[index].disabled = !achievement.completed || achievement.claimed;
            }
        }

        function updateUI() {
            const totalIncome = gameState.businesses.reduce((total, biz) => total + biz.income, 0) * gameState.boostMultiplier;
            document.getElementById('balance').textContent = `$${gameState.money.toFixed(2)}`;
            document.getElementById('income-per-sec').textContent = `+$${totalIncome.toFixed(1)}/сек`;
            document.getElementById('coins-per-click').textContent = gameState.coinsPerClick;

            // НОВОЕ: ОБНОВЛЕНИЕ КОМБО
            document.getElementById('combo-fill').style.width = `${(gameState.comboMultiplier - 1) * 25}%`;
            if (gameState.combo > 1) {
                document.getElementById('combo-text').textContent = `Комбо x${gameState.comboMultiplier.toFixed(1)}!`;
            } else {
                document.getElementById('combo-text').textContent = '';
            }

            renderAllSections();
        }

        function showNotification(message) {
            const notification = document.createElement('div');
            notification.className = 'notification';
            notification.textContent = message;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 2000);
        }

        // СОХРАНЕНИЕ И ЗАГРУЗКА
        function saveGame() {
            gameState.lastSaveTime = Date.now();
            gameState.lastUpdateTime = Date.now();
            localStorage.setItem('dollarEmpireSave', JSON.stringify(gameState));
        }

        function loadGame() {
            try {
                const save = JSON.parse(localStorage.getItem('dollarEmpireSave'));
                if (save) {
                    Object.assign(gameState, save);
                    gameState.lastUpdateTime = Date.now();
                    
                    // Восстанавливаем текущую машину из сохранения
                    if (gameState.currentCar && typeof gameState.currentCar === 'object') {
                        const carIndex = gameState.cars.findIndex(c => c.name === gameState.currentCar.name);
                        if (carIndex !== -1) {
                            gameState.currentCar = gameState.cars[carIndex];
                        }
                    }
                }
            } catch (error) {
                console.log('Нет сохраненной игры, начинаем новую');
            }
        }

        function calculateOfflineEarnings() {
            const save = JSON.parse(localStorage.getItem('dollarEmpireSave'));
            if (save && save.lastUpdateTime) {
                const offlineTime = (Date.now() - save.lastUpdateTime) / 1000;
                
                if (offlineTime > 10) {
                    let totalOfflineIncome = 0;
                    save.businesses.forEach(business => {
                        if (business.level > 0) {
                            totalOfflineIncome += business.income * offlineTime;
                        }
                    });

                    if (totalOfflineIncome > 0) {
                        gameState.money += totalOfflineIncome;
                        gameState.totalEarned += totalOfflineIncome;
                        showNotification(`За время отсутствия: +$${totalOfflineIncome.toFixed(2)}!`);
                    }
                }
            }
        }

        // ЗАПУСК
        window.onload = initGame;
    </script>
</body>
</html>
